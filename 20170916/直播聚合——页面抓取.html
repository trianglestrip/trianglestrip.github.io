<!DOCTYPE html><html class="theme-next mist" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css"><meta name="keywords" content="页面抓取,"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2"><meta name="description" content="之前的捣鼓记录（2016.9.7）　　个人喜欢看高人气的各种主播，而不想斗鱼、战旗、虎牙、熊猫、全民、龙珠、火猫这几个平台，一个个网址的去打开。正是由于这一个想法和初衷，因此开始了这个直播平台高人气主播导航的编(zhe)码(teng)之旅。　　当然，由于根本不会PHP，用这个相当于边搞边学，其中遇到过很多白痴问题，同时义无反顾的跳进了很多坑，然后一步步的趴，毕竟水平有限。到目前为止2016年9月7"><meta name="keywords" content="页面抓取"><meta property="og:type" content="article"><meta property="og:title" content="直播聚合——页面抓取"><meta property="og:url" content="https://trianglestrip.github.io/20170916/直播聚合——页面抓取.html"><meta property="og:site_name" content="凌晨一点的日记"><meta property="og:description" content="之前的捣鼓记录（2016.9.7）　　个人喜欢看高人气的各种主播，而不想斗鱼、战旗、虎牙、熊猫、全民、龙珠、火猫这几个平台，一个个网址的去打开。正是由于这一个想法和初衷，因此开始了这个直播平台高人气主播导航的编(zhe)码(teng)之旅。　　当然，由于根本不会PHP，用这个相当于边搞边学，其中遇到过很多白痴问题，同时义无反顾的跳进了很多坑，然后一步步的趴，毕竟水平有限。到目前为止2016年9月7"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://owc1seupa.bkt.clouddn.com/img/tv.png"><meta property="og:updated_time" content="2017-09-17T02:46:30.141Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="直播聚合——页面抓取"><meta name="twitter:description" content="之前的捣鼓记录（2016.9.7）　　个人喜欢看高人气的各种主播，而不想斗鱼、战旗、虎牙、熊猫、全民、龙珠、火猫这几个平台，一个个网址的去打开。正是由于这一个想法和初衷，因此开始了这个直播平台高人气主播导航的编(zhe)码(teng)之旅。　　当然，由于根本不会PHP，用这个相当于边搞边学，其中遇到过很多白痴问题，同时义无反顾的跳进了很多坑，然后一步步的趴，毕竟水平有限。到目前为止2016年9月7"><meta name="twitter:image" content="http://owc1seupa.bkt.clouddn.com/img/tv.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.2",sidebar:{position:"left",display:"post",offset:12,offset_float:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://trianglestrip.github.io/20170916/直播聚合——页面抓取.html"><title>直播聚合——页面抓取 | 凌晨一点的日记</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凌晨一点的日记</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">记录日常生活、工作点滴</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>留言</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://trianglestrip.github.io/20170916/直播聚合——页面抓取.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="凌晨一点"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凌晨一点的日记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">直播聚合——页面抓取</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-16T16:22:00+08:00">2017-09-16 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span> </a></span></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/20170916/直播聚合——页面抓取.html#SOHUCS" itemprop="discussionUrl"><span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="20170916/直播聚合——页面抓取.html" itemprop="commentsCount"></span> </a><span class="post-meta-divider">|</span> <span class="page-pv"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="之前的捣鼓记录（2016-9-7）"><a href="#之前的捣鼓记录（2016-9-7）" class="headerlink" title="之前的捣鼓记录（2016.9.7）"></a>之前的捣鼓记录（2016.9.7）</h1><p>　　个人喜欢看高人气的各种主播，而不想斗鱼、战旗、虎牙、熊猫、全民、龙珠、火猫这几个平台，一个个网址的去打开。正是由于这一个想法和初衷，因此开始了这个直播平台高人气主播导航的编(zhe)码(teng)之旅。<br>　　当然，由于根本不会PHP，用这个相当于边搞边学，其中遇到过很多白痴问题，同时义无反顾的跳进了很多坑，然后一步步的趴，毕竟水平有限。到目前为止2016年9月7日17:42:25，大概花了一周的每天下班和周末弄弄。虽然打开速度坑爹，但是好歹实现了不是。自我鼓励一下，然后下面就记录一些更新的坑和一些说明。</p><p><img src="http://owc1seupa.bkt.clouddn.com/img/tv.png" alt=""></p><h2 id="数据的抓取和更新"><a href="#数据的抓取和更新" class="headerlink" title="数据的抓取和更新"></a>数据的抓取和更新</h2><p>　　将之前的方法：用户每次访问时，就实时去抓取各个平台的数据并按照人气排序 =&gt; 在后台对每个栏目保存一个抓取的数据，在5分钟内所有的用户访问该栏目则直接读文件；下一个用户访问时，判断服务器当前时间与上次该文件修改时间之差，超过5分钟则从新抓取并更新文件 =&gt; 将下一个用户访问时触发的更新更改为每隔5分钟自动更新。这个自动如何触发呢？利用百度云检测5分钟访问一次我的每个栏目，这样就会让后台触发更新。。。:-)<br><a id="more"></a></p><h2 id="抓取的数据和排序"><a href="#抓取的数据和排序" class="headerlink" title="抓取的数据和排序"></a>抓取的数据和排序</h2><p>　　之前是抓每个平台的栏目的第一页数据,如果人气小于阈值则continue循环读取下一个，然后将所有平台的的数据按照人气进行排序 =&gt; 后来发现每个平台的排序也“大致”是按照人气多少排序，说大致因为有的前几个人很少但是被推荐到前面去了。因此为了加快抓取，对前3个如果人气低于阈值，continue;后面的如果一旦有人气小于阈值直接break，此平台就不再抓了。</p><h2 id="阈值的设置"><a href="#阈值的设置" class="headerlink" title="阈值的设置"></a>阈值的设置</h2><p>　　目前LOL是低于5万直接过滤，星秀呢是2W，音乐是1000（即使这样也经常没有或低于10个。。战旗的全民星秀看了一会无力吐槽根本不想加入星秀或者音乐。。看来还是得引入花椒和YY，这样其他平台就不用混了。。考虑中。。）。 户外是2W，还好，不多不少。。后续再加一些其他平台吧。。<br>　　现在发现最大的问题是速度。。。百度测试速度在10秒以上，目前对于缓存的方式还没搞清楚，等搞清楚优化速度后，再翻新CSS和多抓些主题和内容吧。。<br>　　所以代码类似如这样：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span>(<span class="string">"dom.php"</span>);</div><div class="line">$stack = <span class="keyword">array</span>();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetContext</span><span class="params">()</span></span>&#123;</div><div class="line">       $key = <span class="keyword">array</span>(<span class="string">"lol"</span>,<span class="string">"zhuji"</span>,<span class="string">"show"</span>,<span class="string">"hw"</span>);</div><div class="line">       $i = <span class="number">0</span>;</div><div class="line">       $LessView = <span class="keyword">array</span>( $key[$i++] =&gt; <span class="number">50000</span>,</div><div class="line">                          $key[$i++] =&gt; <span class="number">5000</span>, </div><div class="line">                          $key[$i++] =&gt; <span class="number">10000</span>,</div><div class="line">                          $key[$i++] =&gt; <span class="number">5000</span>);</div><div class="line"> </div><div class="line">       $pageName = $_SERVER[<span class="string">'REQUEST_URI'</span>] ;</div><div class="line">     </div><div class="line">       $pageName = ($pageName ==<span class="string">'/'</span>) ? <span class="string">'lol'</span> : substr($pageName,<span class="number">1</span>);</div><div class="line">       $isList = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">foreach</span>($key <span class="keyword">as</span> $tmp)&#123;</div><div class="line">          <span class="keyword">if</span>($pageName == $tmp)&#123;$isList = <span class="keyword">true</span>;<span class="keyword">break</span>;&#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span>($isList == <span class="keyword">false</span>)&#123;<span class="keyword">return</span>;&#125;</div><div class="line">       </div><div class="line">       $content= <span class="string">''</span>;</div><div class="line">       $WriteAgain = <span class="keyword">true</span>;</div><div class="line">       <span class="comment">//存在对应栏目的5分钟的内容文件则直接读，否则去抓取。</span></div><div class="line">       $cache = <span class="number">1</span>;</div><div class="line">       $filename = <span class="string">'cache/'</span>.$pageName.<span class="string">'.js'</span>;</div><div class="line">       </div><div class="line">       <span class="keyword">if</span> ($cache&amp;&amp;file_exists($filename))&#123;</div><div class="line">           $tmp = filemtime($filename);</div><div class="line">           $Old = idate(<span class="string">'i'</span>,$tmp);</div><div class="line">           $Now =  idate(<span class="string">"i"</span>);</div><div class="line">          </div><div class="line">           $notSameH = idate(<span class="string">'H'</span>,$tmp) - idate(<span class="string">'H'</span>);</div><div class="line">                      </div><div class="line">           <span class="keyword">if</span>(($Now - $Old &lt; <span class="number">8</span>) &amp;&amp; !$notSameH )&#123;</div><div class="line">           </div><div class="line">             $WriteAgain = <span class="keyword">true</span>;               </div><div class="line">             $content = file_get_contents($filename,<span class="keyword">true</span>);<span class="comment">//json_decode</span></div><div class="line">             $content = substr($content ,<span class="number">1</span>,strlen($content )<span class="number">-2</span>); </div><div class="line">             $content = str_replace(<span class="string">"\\"</span>,<span class="string">""</span>,$content );</div><div class="line">             $content = json_decode($content);</div><div class="line">             </div><div class="line">            <span class="comment">// $content = str_replace("\//","\/",$content );</span></div><div class="line">             <span class="comment">//echo "读文件想嘻嘻嘻嘻嘻嘻";</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span>($cache&amp;&amp;$WriteAgain  )&#123;</div><div class="line">              </div><div class="line">              $content = GetSrcAndSortByView($pageName,$LessView[$pageName]);</div><div class="line">              $fp = fopen($filename,<span class="string">"w"</span>); </div><div class="line">            </div><div class="line">              $tmp = json_encode($content, JSON_UNESCAPED_UNICODE) ;</div><div class="line">             <span class="comment">//$tmp  = iconv("UTF-8","UTF-8//IGNORE",$tmp );</span></div><div class="line">       	      fwrite($fp,var_export($tmp, <span class="keyword">true</span>)); </div><div class="line">              fclose($fp);</div><div class="line">              <span class="comment">//echo "重新抓取YYYYYYYYYYYYYYYYYYYY";</span></div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       <span class="keyword">if</span>(!$cache) $content=GetSrcAndSortByView($pageName,$LessView[$pageName]);</div><div class="line">       </div><div class="line">       <span class="keyword">return</span> $content ;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetSrcAndSortByView</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">global</span> $stack ;</div><div class="line">   </div><div class="line">   Get_Douyu($gameName,$Views);</div><div class="line">   Get_Quanmin($gameName,$Views); </div><div class="line">   Get_Zhanqi($gameName,$Views);</div><div class="line">   Get_Panda($gameName,$Views);</div><div class="line">   Get_Longzhu($gameName,$Views);</div><div class="line">   Get_Huya($gameName,$Views);</div><div class="line">   </div><div class="line">   $sort = <span class="keyword">array</span>();</div><div class="line">   <span class="keyword">foreach</span>($stack <span class="keyword">as</span> $arr2)&#123;</div><div class="line">      $sort[] = $arr2[<span class="number">0</span>];</div><div class="line">   &#125;</div><div class="line">   array_multisort($sort, SORT_DESC, $stack );	</div><div class="line">   <span class="keyword">return</span> $stack;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get_Str</span><span class="params">($str)</span></span>&#123;</div><div class="line">   preg_match(<span class="string">"/&gt;(.*?)&lt;/is"</span>,$str,$attr);</div><div class="line">   <span class="keyword">return</span> $attr[<span class="number">1</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get_Douyu</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line">   ;</div><div class="line">    <span class="keyword">switch</span>($gameName)&#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'lol'</span>:   </div><div class="line">      	  Get_DouyuMulti(<span class="string">'LOL'</span>,$Views);</div><div class="line">      	  <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'zhuji'</span>:   </div><div class="line">      	  Get_DouyuMulti(<span class="string">'TVgame'</span>,$Views);</div><div class="line">      	  <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'show'</span>: </div><div class="line">          Get_DouyuMulti(<span class="string">'yz'</span>,$Views);</div><div class="line">          <span class="comment">//Get_DouyuMulti('ss',$Views);</span></div><div class="line">          Get_DouyuMulti(<span class="string">'shx'</span>,$Views);</div><div class="line">          Get_DouyuMulti(<span class="string">'xx'</span>,$Views);</div><div class="line">          Get_DouyuMulti(<span class="string">'music'</span>,$Views);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'hw'</span>:   </div><div class="line">      	  Get_DouyuMulti(<span class="string">'outdoor'</span>,$Views);</div><div class="line">      	  Get_DouyuMulti(<span class="string">'ms'</span>,$Views);</div><div class="line">      	  Get_DouyuMulti(<span class="string">'hw'</span>,$Views);</div><div class="line">      	  <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">default</span>: <span class="keyword">return</span>;</div><div class="line">   &#125; </div><div class="line">         </div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get_DouyuMulti</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line">   <span class="keyword">global</span> $stack ;</div><div class="line">   $html = <span class="keyword">new</span> simple_html_dom();</div><div class="line">   $rootUrl = <span class="string">'http://www.douyu.com'</span>;</div><div class="line">       </div><div class="line">   $html-&gt;load_file($rootUrl.<span class="string">'/directory/game/'</span>.$gameName);</div><div class="line">   $Nnum = <span class="number">0</span>;</div><div class="line">   <span class="keyword">foreach</span>($html-&gt;find(<span class="string">'#live-list-contentbox li a'</span>) <span class="keyword">as</span> $element)&#123;</div><div class="line">   	$count = Get_Str($element-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">1</span>));</div><div class="line">   	<span class="keyword">if</span>(strpos($count,<span class="string">"万"</span>)) &#123;$count = floatval($count)*<span class="number">10000.0</span>;&#125;</div><div class="line">   	   	</div><div class="line">   	$NotPass = ($count &lt; $Views) ? <span class="number">1</span> : <span class="number">0</span>; <span class="keyword">if</span>( $Nnum++ &lt; <span class="number">12</span> )&#123;<span class="keyword">if</span>($NotPass) &#123; <span class="keyword">continue</span>;&#125;&#125;<span class="keyword">else</span> <span class="keyword">if</span>($NotPass)&#123; <span class="keyword">break</span>;&#125;</div><div class="line">   	   	   	</div><div class="line">   	$pic = $element-&gt;children(<span class="number">0</span>)-&gt;children(<span class="number">2</span>)-&gt;attr[<span class="string">"data-original"</span>];</div><div class="line">   	$href = $rootUrl.$element-&gt;href;</div><div class="line">	$title = $element-&gt;title;	</div><div class="line">	$name = Get_Str($element-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">0</span>));</div><div class="line">           </div><div class="line">       $stack[] = <span class="keyword">array</span>($count,$title,$name,$pic,$href ,<span class="string">"斗鱼"</span>);</div><div class="line">      </div><div class="line">   &#125;</div><div class="line">   $html-&gt;clear();  </div><div class="line">   </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get_Panda</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">switch</span>($gameName)&#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'lol'</span>:  $gameName =<span class="string">'lol'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'zhuji'</span>:  $gameName =<span class="string">'zhuji'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'show'</span>:  $gameName =<span class="string">'yzdr'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'hw'</span>:  $gameName =<span class="string">'hwzb'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">default</span>: <span class="keyword">return</span>; </div><div class="line">   &#125; </div><div class="line">   </div><div class="line">   <span class="keyword">global</span> $stack ;</div><div class="line">   $html = <span class="keyword">new</span> simple_html_dom();</div><div class="line">   $rootUrl = <span class="string">'http://www.panda.tv'</span>;</div><div class="line">      </div><div class="line">   $html-&gt;load_file($rootUrl.<span class="string">'/cate/'</span>.$gameName);</div><div class="line">   $Nnum = <span class="number">0</span>;</div><div class="line">   <span class="keyword">foreach</span>($html-&gt;find(<span class="string">'#sortdetail-container li a'</span>) <span class="keyword">as</span> $element)&#123;</div><div class="line">   	$count = Get_Str($element-&gt;children(<span class="number">2</span>)-&gt;children(<span class="number">1</span>));</div><div class="line">   	$NotPass = ($count &lt; $Views) ? <span class="number">1</span> : <span class="number">0</span>; <span class="keyword">if</span>( $Nnum++ &lt; <span class="number">12</span> )&#123;<span class="keyword">if</span>($NotPass) &#123; <span class="keyword">continue</span>;&#125;&#125;<span class="keyword">else</span> <span class="keyword">if</span>($NotPass)&#123; <span class="keyword">break</span>;&#125;</div><div class="line">   	   	   	</div><div class="line">   	$pic = $element-&gt;children(<span class="number">0</span>)-&gt;children(<span class="number">0</span>)-&gt;attr[<span class="string">"data-original"</span>];</div><div class="line">   	$href = $rootUrl.$element-&gt;href;</div><div class="line">	$title = $element-&gt;children(<span class="number">0</span>)-&gt;children(<span class="number">0</span>)-&gt;attr[<span class="string">"alt"</span>];;	</div><div class="line">	$name = Get_Str($element-&gt;children(<span class="number">2</span>)-&gt;children(<span class="number">0</span>));</div><div class="line">        </div><div class="line">       $stack[] = <span class="keyword">array</span>($count,$title,$name,$pic,$href ,<span class="string">"熊猫"</span>);</div><div class="line">       </div><div class="line">   &#125;</div><div class="line">   $html-&gt;clear();  </div><div class="line">   <span class="comment">//print_r ($stack);</span></div><div class="line">   </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//<span class="doctag">TODO:</span> zhuji</span></div><div class="line"><span class="comment">//太容易超时了，直接超过4个BREAK;</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get_Longzhu</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line"></div><div class="line">     <span class="keyword">switch</span>($gameName)&#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'lol'</span>:  $gameName =<span class="string">'lol'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'show'</span>:  $gameName =<span class="string">'yuzhai'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'hw'</span>:  $gameName =<span class="string">'huwai'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">default</span>: <span class="keyword">return</span>; </div><div class="line">   &#125; </div><div class="line">   </div><div class="line">   <span class="keyword">global</span> $stack ;</div><div class="line">   $html = <span class="keyword">new</span> simple_html_dom();</div><div class="line">   $rootUrl = <span class="string">'http://longzhu.com'</span>;</div><div class="line">   $html-&gt;load_file($rootUrl.<span class="string">'/channels/'</span>.$gameName);</div><div class="line">   $Nnum = <span class="number">0</span>;</div><div class="line">   <span class="keyword">foreach</span>($html-&gt;find(<span class="string">'#list-con a.livecard'</span>) <span class="keyword">as</span> $element)&#123;</div><div class="line">   	$count = Get_Str($element-&gt;children(<span class="number">2</span>)-&gt;children(<span class="number">0</span>)-&gt;children(<span class="number">1</span>)); </div><div class="line">   	$NotPass = ($count &lt; $Views) ? <span class="number">1</span> : <span class="number">0</span>; <span class="keyword">if</span>( $Nnum++ &lt; <span class="number">4</span> )&#123;<span class="keyword">if</span>($NotPass) &#123; <span class="keyword">continue</span>;&#125;&#125;<span class="keyword">else</span> <span class="keyword">if</span>($NotPass)&#123; <span class="keyword">break</span>;&#125;</div><div class="line">   	   	   	</div><div class="line">   	$pic = $element-&gt;children(<span class="number">0</span>)-&gt;attr[<span class="string">"src"</span>];</div><div class="line">   	$href = $element-&gt;href;</div><div class="line">	$title = $element-&gt;children(<span class="number">0</span>)-&gt;attr[<span class="string">"alt"</span>];;	</div><div class="line">	$name = Get_Str($element-&gt;children(<span class="number">3</span>)-&gt;children(<span class="number">0</span>));</div><div class="line">        </div><div class="line">       $stack[] = <span class="keyword">array</span>($count,$title,$name,$pic,$href ,<span class="string">"龙珠"</span>);</div><div class="line">      </div><div class="line">   &#125;</div><div class="line">   $html-&gt;clear();  </div><div class="line">   <span class="comment">//print_r ($stack);</span></div><div class="line">   </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//<span class="doctag">TODO:</span> only lol</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get_Zhanqi</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span>($gameName)&#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'lol'</span>:  $gameName =<span class="string">'lol'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'zhuji'</span>: <span class="comment">//人气高的是守望先锋，算了</span></div><div class="line">      <span class="keyword">case</span> <span class="string">'show'</span>:  </div><div class="line">      <span class="keyword">case</span> <span class="string">'hw'</span>:  </div><div class="line">      <span class="keyword">default</span>: <span class="keyword">return</span>;</div><div class="line">   &#125; </div><div class="line">   </div><div class="line">   <span class="keyword">global</span> $stack ;</div><div class="line">   $html = <span class="keyword">new</span> simple_html_dom();</div><div class="line">   $rootUrl = <span class="string">'https://www.zhanqi.tv'</span>;</div><div class="line">   $html-&gt;load_file($rootUrl.<span class="string">'/games/'</span>.$gameName);</div><div class="line">   $Nnum = <span class="number">0</span>;</div><div class="line">   <span class="keyword">foreach</span>($html-&gt;find(<span class="string">'ul.js-room-list-ul li a'</span>) <span class="keyword">as</span> $element)&#123;</div><div class="line">   </div><div class="line">        $name = Get_Str($element-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">2</span>));</div><div class="line">        <span class="keyword">if</span>($name == <span class="string">'lyingman'</span>) <span class="keyword">continue</span>;</div><div class="line">        </div><div class="line">   	$count = Get_Str($element-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">0</span>)-&gt;children(<span class="number">1</span>));</div><div class="line">   	<span class="keyword">if</span>(strpos($count,<span class="string">"万"</span>)) &#123;$count = floatval($count)*<span class="number">10000.0</span>;&#125;</div><div class="line">   	$NotPass = ($count &lt; $Views) ? <span class="number">1</span> : <span class="number">0</span>; <span class="keyword">if</span>( $Nnum++ &lt; <span class="number">12</span> )&#123;<span class="keyword">if</span>($NotPass) &#123; <span class="keyword">continue</span>;&#125;&#125;<span class="keyword">else</span> <span class="keyword">if</span>($NotPass)&#123; <span class="keyword">break</span>;&#125;</div><div class="line">   	   	   	</div><div class="line">   	$pic = ($element-&gt;children(<span class="number">0</span>)-&gt;children(<span class="number">2</span>)-&gt;attr[<span class="string">"src"</span>]);</div><div class="line">   	$href = $rootUrl.$element-&gt;href;</div><div class="line">	$title = Get_Str($element-&gt;children(<span class="number">1</span>)-&gt;children(<span class="number">0</span>));	</div><div class="line">	       </div><div class="line">        $stack[] = <span class="keyword">array</span>($count,$title,$name,$pic,$href ,<span class="string">"战旗"</span>);</div><div class="line">      </div><div class="line">   &#125;</div><div class="line">   $html-&gt;clear();  </div><div class="line">   <span class="comment">//print_r ($stack);</span></div><div class="line">   </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//<span class="doctag">TODO:</span> only lol</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get_Huya</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line">    <span class="keyword">switch</span>($gameName)&#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'lol'</span>:  $gameName = <span class="number">1</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'zhuji'</span>:   <span class="comment">//最高人气才1W多点，懒得抓</span></div><div class="line">      <span class="keyword">case</span> <span class="string">'show'</span>:  </div><div class="line">      <span class="keyword">case</span> <span class="string">'hw'</span>:  </div><div class="line">      <span class="keyword">default</span>: <span class="keyword">return</span>;</div><div class="line">   &#125; </div><div class="line">   </div><div class="line">   </div><div class="line"></div><div class="line">   <span class="keyword">if</span>($gameName == <span class="number">1</span>) HuyaAjax($gameName,$Views);</div><div class="line">     </div><div class="line">&#125;</div><div class="line"><span class="comment">//lol用的异步JSON文件，其他的反而不是。。</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">HuyaAjax</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line">  <span class="keyword">global</span> $stack ;</div><div class="line">  $rootUrl = <span class="string">'http://www.huya.com/'</span>;</div><div class="line">  $handle = fopen(<span class="string">"http://www.huya.com/index.php?m=Game&amp;do=ajaxGameLiveByPage&amp;gid="</span>.$gameName .<span class="string">"&amp;page=1"</span>,<span class="string">"rb"</span>);</div><div class="line">   $content = <span class="string">""</span>;</div><div class="line">   <span class="keyword">while</span> (!feof($handle)) &#123;</div><div class="line">     $content .= fread($handle, <span class="number">10000</span>);</div><div class="line">   &#125;</div><div class="line">   fclose($handle);</div><div class="line">   $content = json_decode($content);</div><div class="line">   $Nnum = <span class="number">0</span>;</div><div class="line">   <span class="keyword">foreach</span>($content-&gt;data-&gt;list <span class="keyword">as</span> $key)&#123;</div><div class="line">     </div><div class="line">     $NotPass = (floatval($key-&gt;totalCount) &lt; $Views) ? <span class="number">1</span> : <span class="number">0</span>; <span class="keyword">if</span>( $Nnum++ &lt; <span class="number">12</span> )&#123;<span class="keyword">if</span>($NotPass) &#123; <span class="keyword">continue</span>;&#125;&#125;<span class="keyword">else</span> <span class="keyword">if</span>($NotPass)&#123; <span class="keyword">break</span>;&#125;</div><div class="line">     $stack[] = <span class="keyword">array</span>($key-&gt;totalCount,$key-&gt;roomName,$key-&gt;nick,$key-&gt;screenshot,$rootUrl.$key-&gt;privateHost,<span class="string">"虎牙"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//<span class="doctag">TODO:</span> music</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get_Quanmin</span><span class="params">($gameName,$Views)</span></span>&#123;</div><div class="line">   </div><div class="line">   <span class="keyword">switch</span>($gameName)&#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'lol'</span>:  $gameName =<span class="string">'lol'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'zhuji'</span>:  $gameName =<span class="string">'tvgame'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'show'</span>:  $gameName =<span class="string">'beauty'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'hw'</span>:  $gameName =<span class="string">'huwai'</span>;<span class="keyword">break</span>;</div><div class="line">      <span class="keyword">default</span>: <span class="keyword">return</span>;</div><div class="line">   &#125; </div><div class="line">   </div><div class="line">   <span class="keyword">global</span> $stack ;</div><div class="line">   $rootUrl = <span class="string">'http://www.quanmin.tv/v/'</span>;</div><div class="line">   $handle = fopen(<span class="string">"http://www.quanmin.tv/json/categories/"</span>.$gameName.<span class="string">"/list.json"</span>,<span class="string">"rb"</span>);</div><div class="line">   $content = <span class="string">""</span>;</div><div class="line">   <span class="keyword">while</span> (!feof($handle)) &#123;</div><div class="line">     $content .= fread($handle, <span class="number">10000</span>);</div><div class="line">   &#125;</div><div class="line">   fclose($handle);</div><div class="line">   $content = json_decode($content);</div><div class="line">   $Nnum = <span class="number">0</span>;</div><div class="line">   <span class="keyword">foreach</span>($content-&gt;data <span class="keyword">as</span> $key)&#123;</div><div class="line">     $NotPass = (floatval($key-&gt;view) &lt; $Views) ? <span class="number">1</span> : <span class="number">0</span>; <span class="keyword">if</span>( $Nnum++ &lt; <span class="number">12</span> )&#123;<span class="keyword">if</span>($NotPass) &#123; <span class="keyword">continue</span>;&#125;&#125;<span class="keyword">else</span> <span class="keyword">if</span>($NotPass)&#123; <span class="keyword">break</span>;&#125;</div><div class="line">     $stack[] = <span class="keyword">array</span>($key-&gt;view,$key-&gt;title,$key-&gt;nick,$key-&gt;thumb,$rootUrl.$key-&gt;uid ,<span class="string">"全民"</span>);</div><div class="line">     </div><div class="line">   &#125;</div><div class="line">  <span class="comment">// print_r ($stack);</span></div><div class="line">   </div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>　　这是去年心血来潮每天晚上捣鼓一会，搞了一个星期的成果。结果一段时间后由于虚拟主机的自动记录errorlog达到了惊人的4G，直接撑爆了我的主机空间，必须定时的清理，零零碎碎的问题导致停滞了。现在打算又重新捣鼓一遍放在VPS上，以后再更新记录吧。</p><h1 id="一年之后的新动作-2017-9-5"><a href="#一年之后的新动作-2017-9-5" class="headerlink" title="一年之后的新动作(2017.9.5)"></a>一年之后的新动作(2017.9.5)</h1><p>　　没想到，我居然又回来弄了。之前用洛杉矶的VPS只顾着挂VPN翻墙用了，速度很勉强，所以弄这种抓取就不太适合。直到8月底，由于域名快到期了，登上了我的阿里云，偶然发现有6元的虚拟共享主机可以买（200mb空间10G月流量），其实用coding pages也可以凑合。后来想着便宜就买了，挂上之前的直播抓取发现速度相当快，于是重新弄弄直播聚合的想法又出来了。<br>　　哈哈，最近比较流行吃鸡，刚好斗鱼和熊猫都有些主播喜欢看，于是就只弄LOL和吃鸡两个的抓取。于是下班后就弄弄。舍弃了之前使用的某个抓取库，直接用curl，网上一堆对比file_get_contents下curl有多快之类的，使用时发现速度确实快了很多。<br>　　比如抓取斗鱼的：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">function</span> <span class="title">grab_single_page</span>(<span class="params">$type,$pageId</span>)</span>&#123;</div><div class="line"></div><div class="line">	$preUrl = <span class="string">'https://www.douyu.com/directory/game/'</span>;</div><div class="line">	$url = $preUrl.$type.<span class="string">'?page='</span>.$pageId.<span class="string">'&amp;isAjax=1'</span>;</div><div class="line">	<span class="keyword">if</span>($GLOBALS[<span class="string">'_DEBUG_'</span>])echo <span class="string">'start read '</span>.$type.<span class="string">' page:'</span>.$pageId .<span class="string">'  .....&lt;br&gt;'</span>;</div><div class="line">	$html = curl_get_contents($url);</div><div class="line"></div><div class="line"> 		<span class="comment">//return $html;</span></div><div class="line"> 		$<span class="keyword">this</span>-&gt;parse_html($html);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_html</span>(<span class="params">$html</span>)</span>&#123;</div><div class="line"></div><div class="line">	$li = <span class="string">'/&lt;li class([\s\S]*)&lt;\/li&gt;/Us'</span>;<span class="comment">// 非贪婪模式 匹配每一个</span></div><div class="line">	preg_match_all($li,$html,$lists);</div><div class="line">	<span class="comment">//var_dump($lists[1]);</span></div><div class="line"></div><div class="line">	$href = <span class="string">'href=\"\/(.*)\"'</span>;</div><div class="line">	$title = <span class="string">' title=\"(.*)\"'</span>;</div><div class="line">	$image = <span class="string">'&lt;img data-original=\"(.*)\"'</span>;</div><div class="line">	$name = <span class="string">'&lt;span class=\"dy-name ellipsis fl\"&gt;(.*)&lt;\/span&gt;'</span>;</div><div class="line">	$views = <span class="string">'&lt;span class=\"dy-num fr\"  &gt;(.*)&lt;\/span&gt;'</span>;</div><div class="line">	<span class="comment">//$pa = '/'.$href.$title.'([\s\S]*)'.$image.'([\s\S]*)'.$name.'([\s\S]*)'.$viewer.'/Us';</span></div><div class="line">	$pa = <span class="string">'/'</span>.$href.$title.<span class="string">'([\s\S]*)'</span>.$image.<span class="string">'([\s\S]*)'</span>.$name.<span class="string">'([\s\S]*)'</span>.$views.<span class="string">'/Us'</span>;</div><div class="line">	<span class="comment">//$pa = '/href=\"\/(.*)\" title=\"(.*)\"([\s\S]*)&lt;img data-original=\"(.*)\"([\s\S]*)/Us';</span></div><div class="line">	foreach ($lists[<span class="number">1</span>] <span class="keyword">as</span> $item) &#123;</div><div class="line">		# code...</div><div class="line">		preg_match_all($pa,$item,$Str);</div><div class="line"></div><div class="line">		<span class="comment">//var_dump($Str);</span></div><div class="line">		$viewCount = $Str[<span class="number">8</span>][<span class="number">0</span>];</div><div class="line">		<span class="keyword">if</span>(strpos($viewCount,<span class="string">"万"</span>)) &#123;$viewCount = intval(floatval($viewCount)*<span class="number">10000.0</span>);&#125;</div><div class="line"></div><div class="line">		$<span class="keyword">this</span>-&gt;collect[] = array(</div><div class="line">			<span class="string">'href'</span> =&gt; <span class="string">'https://www.douyu.com/'</span>.$Str[<span class="number">1</span>][<span class="number">0</span>] , </div><div class="line">			<span class="string">'title'</span> =&gt; $Str[<span class="number">2</span>][<span class="number">0</span>] , </div><div class="line">			<span class="string">'image'</span> =&gt; $Str[<span class="number">4</span>][<span class="number">0</span>] , </div><div class="line">			<span class="string">'name'</span> =&gt; $Str[<span class="number">6</span>][<span class="number">0</span>] , </div><div class="line">			<span class="string">'views'</span> =&gt; $viewCount,</div><div class="line">			<span class="string">'tvName'</span> =&gt; <span class="string">'斗鱼TV'</span></div><div class="line">		);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>　　然后抓取页数，遍历每一页的如上数据存起来即可。最后把斗鱼和熊猫的放一起按照人气排序：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">$obj = array(</div><div class="line">      <span class="string">'douyu'</span> =&gt; <span class="keyword">new</span> douyu_pc(),</div><div class="line">      <span class="string">'panda'</span> =&gt; <span class="keyword">new</span> panda_pc()</div><div class="line">    );</div><div class="line"></div><div class="line">$type = isset($_GET[<span class="string">'id'</span>]) ? $_GET[<span class="string">'id'</span>] : <span class="string">'lol'</span> ;</div><div class="line">$page = isset($_GET[<span class="string">'page'</span>]) ? intval($_GET[<span class="string">'page'</span>]) : <span class="number">1</span> ;</div><div class="line"></div><div class="line">$stack =  array();</div><div class="line">$start = <span class="number">0</span>;</div><div class="line">foreach ($obj <span class="keyword">as</span> $key =&gt; $object) &#123;</div><div class="line">    </div><div class="line">    $className = $GLOBALS[<span class="string">'_CONFIG_'</span>][$type][$key];</div><div class="line">    <span class="keyword">if</span>($className == <span class="string">''</span>)&#123;<span class="keyword">continue</span>;&#125;</div><div class="line">    $item_array = $object-&gt;get_all_pages( $className);</div><div class="line">  </div><div class="line">    $len =count($item_array);</div><div class="line">    <span class="keyword">for</span>($i = <span class="number">0</span> ; $i &lt; $len; $i++) &#123;</div><div class="line">      $stack[$start+$i] = $item_array[$i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $start = $len;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"> </div><div class="line"></div><div class="line">$sort = array();</div><div class="line">foreach($stack <span class="keyword">as</span> $arr)&#123;</div><div class="line">    $sort[] = $arr[<span class="string">'views'</span>];</div><div class="line">&#125;</div><div class="line">array_multisort($sort, SORT_DESC,$stack );</div></pre></td></tr></table></figure><p></p><p>　　这次就没有弄存储，每次访问都是实时的去抓取，而且抓取并显示的是所有的页，不再限制人气在多少以下。然后对他们进行排序。虽然目前看起来还是有一点慢，但是对我而言还是足够了。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> 凌晨一点</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://trianglestrip.github.io/20170916/直播聚合——页面抓取.html" title="直播聚合——页面抓取">https://trianglestrip.github.io/20170916/直播聚合——页面抓取.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/页面抓取/" rel="tag"># 页面抓取</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/20170326/戒指渲染-二-——新的实现方法.html" rel="next" title="戒指渲染(二)——根据深度融合"><i class="fa fa-chevron-left"></i> 戒指渲染(二)——根据深度融合</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="cyEmoji" role="cylabs" data-use="emoji"></div><div id="SOHUCS"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="凌晨一点"><p class="site-author-name" itemprop="name">凌晨一点</p><p class="site-description motion-element" itemprop="description">苔痕上阶绿，草色入帘青</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">2</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">2</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/trianglestrip" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="http://weibo.com/11244237" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i>Weibo</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://googlo.me/" title="云落" target="_blank">云落</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#之前的捣鼓记录（2016-9-7）"><span class="nav-number">1.</span> <span class="nav-text">之前的捣鼓记录（2016.9.7）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据的抓取和更新"><span class="nav-number">1.1.</span> <span class="nav-text">数据的抓取和更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#抓取的数据和排序"><span class="nav-number">1.2.</span> <span class="nav-text">抓取的数据和排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#阈值的设置"><span class="nav-number">1.3.</span> <span class="nav-text">阈值的设置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一年之后的新动作-2017-9-5"><span class="nav-number">2.</span> <span class="nav-text">一年之后的新动作(2017.9.5)</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2017</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">凌晨一点</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span title="Site words total count">3.1k </span><span class="post-meta-divider">|</span> <span class="site-uv"><i class="fa fa-user"></i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div><div class="powered-by">由 <a class="theme-link" href="https://hexo.io" target="_blank">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank">NexT.Mist</a> v5.1.2</div><span class="post-meta-divider">|</span><div class="powered-by"><a class="theme-link" href="http://www.miitbeian.gov.cn" target="_blank">鲁ICP备17041494号</a></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script><script type="text/javascript">!function(){var t="6ee52971b802b6d034dbee11e7c815f9";if((window.innerWidth||document.documentElement.clientWidth)<960)window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=cysVXW3G4&conf='+t+'"><\/script>');else{!function(t,e){var n=document.getElementsByTagName("head")[0]||document.head||document.documentElement,a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("charset","UTF-8"),a.setAttribute("src",t),"function"==typeof e&&(window.attachEvent?a.onreadystatechange=function(){var t=a.readyState;"loaded"!==t&&"complete"!==t||(a.onreadystatechange=null,e())}:a.onload=e),n.appendChild(a)}("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:"cysVXW3G4",conf:t})})}}()</script><script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script><script type="text/javascript" charset="utf-8" src="https://changyan.sohu.com/js/changyan.labs.https.js?appid=cysVXW3G4"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script></body></html>